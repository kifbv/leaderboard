## Codebase Patterns

**Prisma client import:** `import { prisma } from "../lib/prisma"` (relative from src/). The singleton is at `src/lib/prisma.ts`.
**Prisma model types:** `import type { Player } from "../generated/prisma/client"` (relative from src/).
**API routes:** Next.js App Router convention — `app/api/[route]/route.ts` with `export async function GET/POST(req)`.
**Prisma 7 seed config:** Seed command goes in `prisma.config.ts` under `migrations.seed`, NOT in `package.json`. Use `tsx prisma/seed.ts` with `tsx` installed as devDependency.
**Seed script pattern:** Import PrismaClient and adapter directly (not the lib/prisma singleton) — the singleton uses globalThis for hot-reload which doesn't apply in scripts.
**Tailwind v4:** CSS file uses `@import "tailwindcss"` (not the v3 directives). No `tailwind.config.ts` needed.
**ESLint immutability:** react-hooks/immutability rule flags `let` variable reassignment inside render scope. Use `reduce` instead of mutation inside `.map()` callbacks.
**Server components + data fetching:** Use `export const dynamic = "force-dynamic"` to prevent caching; query Prisma directly rather than making HTTP calls to API routes.

**Unit testing pattern:** `vitest run` with `npm test`. Tests live at `src/lib/*.test.ts`. No config file needed — vitest works out of the box for pure TS utility files.
**Route shadowing gotcha:** If a root-level `app/` directory exists alongside `src/app/`, Next.js App Router picks up `app/` at root first, silently ignoring `src/app/`. This manifests as all custom routes returning 404 with zero error output. Fix: remove the stale root `app/` directory.
**Interactive UI pattern:** Split into server component (page.tsx — fetches data from Prisma) + client component (XxxForm.tsx — handles state, events). Server component uses `select:` to minimize data sent to client.
**SQLite case-insensitive search:** Prisma with SQLite does NOT support `mode: "insensitive"` — use app-level: `items.find(x => x.name.toLowerCase() === input.toLowerCase())`.
**Dynamic route params:** Next.js App Router passes params as `Promise<{ param: string }>` — always `await params` before destructuring.
**Tailwind v4 custom tokens:** Define in `@theme {}` block in `globals.css`. Use as `bg-primary`, `bg-background-dark`, etc. — no tailwind.config.js needed.
**Next.js Link rule:** ESLint `@next/next/no-html-link-for-pages` requires `<Link>` from `next/link` instead of `<a href="...">` for page routes. Client components must `import Link from "next/link"`.
**Avatar deterministic color:** Hash player name to pick from a fixed palette of Tailwind colors. Use bitwise `& 0xffffffff` to keep hash in 32-bit range.

---

# Ralph Progress Log

Started: 2026-02-11
---

## 2026-02-11 - US-001
- Initialized Next.js 16 (App Router) with TypeScript and Tailwind CSS
- Installed Prisma 7 with SQLite via `@prisma/adapter-better-sqlite3` driver adapter
- Created schema: Player, Match, MatchPlayer models with initial migration
- Created `src/lib/prisma.ts` singleton using PrismaBetterSqlite3 adapter
- **Learnings for future iterations:**
  - Prisma 7 uses new `prisma-client` generator (not `prisma-client-js`), output goes to `src/generated/prisma/` with no index.ts — import from `../generated/prisma/client`
  - Prisma 7 requires a driver adapter for SQLite: `PrismaBetterSqlite3` from `@prisma/adapter-better-sqlite3`
  - `PrismaClientOptions` requires either `adapter` or `accelerateUrl` — no direct connection option
  - `@/*` path alias maps to project root (not `src/`), so use relative imports inside `src/`
  - DATABASE_URL is `file:./dev.db` (relative to project root); db file lives at project root
  - `create-next-app` can't run in a non-empty directory — create in temp dir and copy files over
---

## 2026-02-11 - US-002
- Created `prisma/seed.ts` with 6 players (varying ELO 998–1320, wins, losses)
- Installed `tsx` as devDependency for running TypeScript seed scripts
- Configured seed command in `prisma.config.ts` under `migrations.seed`
- Added `prisma.seed` key to `package.json` (informational only; Prisma 7 reads from config)
- Verified: `npx prisma db seed` works; idempotent via `upsert`
- Files changed: `prisma/seed.ts`, `prisma.config.ts`, `package.json`
- **Learnings for future iterations:**
  - Prisma 7 reads seed command from `prisma.config.ts` → `migrations.seed`, not `package.json`
  - Use `tsx` (not `ts-node`) for TypeScript seed scripts — simpler, works with ESM
  - Seed scripts should create their own PrismaClient (not import the Next.js singleton) to avoid globalThis issues
---

## 2026-02-14 - US-013 through US-021 (Design Alignment Phase)
- Implemented full dark mode UI restyling across all pages
- **US-013:** Updated `globals.css` with Tailwind v4 `@theme {}` color tokens (#135bec primary, #0b121e dark bg, #0d1625 card dark); added Google Fonts imports (Lexend + Material Symbols); updated `layout.tsx` to add `className="dark"`, remove nav, wrap children in `max-w-md`
- **US-014:** Leaderboard sticky header with sports_tennis icon + "TGSB Leaderboard" title; floating "Log Match" FAB with primary glow shadow
- **US-015:** Top-3 podium layout with initials avatars, deterministic bg colors, rank badges (gold/silver/bronze), -mt-4 center raise
- **US-016:** Replaced table with div card rows — `bg-card-dark` cards with initials avatar, rank, name+subtitle, ELO right-aligned
- **US-017/018/019:** LogMatchForm.tsx fully restyled — modal header with close (X) Link, Singles/Doubles toggle with `bg-primary` active state, 2-column player dropdowns with custom SVG chevron, dark winner buttons, dark success/error feedback
- **US-020:** AdminRosterForm.tsx restyled — `bg-slate-900` input, `bg-primary` button, `bg-card-dark` player list, dark error/success messages
- **US-021:** Final QA — fixed ESLint error (`<a>` → `<Link>` in LogMatchForm), removed unused `isThird` var; `tsc`, `lint`, `build` all pass
- Files changed: `src/app/globals.css`, `src/app/layout.tsx`, `src/app/page.tsx`, `src/app/log-match/LogMatchForm.tsx`, `src/app/admin/[secret]/AdminRosterForm.tsx`
- **Learnings for future iterations:**
  - Tailwind v4 custom tokens use `@theme {}` in globals.css; accessed as `bg-primary`, `text-primary`, etc. — no config file
  - `@next/next/no-html-link-for-pages` ESLint rule requires `<Link>` from `next/link` for any `<a href="...">` pointing to app routes in client components
  - Deterministic avatar colors: hash name string with `charCodeAt` + `& 0xffffffff` → index into fixed color palette
  - Google Fonts `@import url(...)` must come BEFORE `@import "tailwindcss"` in globals.css (PostCSS processes imports in order)
  - Unused variables from ternary chains (e.g. `isThird` never used in JSX) will be caught by ESLint — clean them up
---

## 2026-02-11 - US-004
- Created `src/app/globals.css` with Tailwind v4 `@import "tailwindcss"` directive
- Created `src/app/layout.tsx` — app shell with nav bar (Leaderboard title + "Log Match" link)
- Created `src/app/page.tsx` — server component fetching players directly from Prisma, computing rank (ties share rank) and winRate, showing table with rank/name/ELO/W/L/Win%; empty state "No players yet"
- Files changed: `src/app/globals.css`, `src/app/layout.tsx`, `src/app/page.tsx`
- **Learnings for future iterations:**
  - Tailwind v4 uses `@import "tailwindcss"` in CSS (not `@tailwind base/components/utilities`)
  - ESLint react-hooks/immutability rule flags `let` reassignment inside render — use `reduce` instead of `let rank = 1` + `.map()` mutation
  - Next.js App Router server components should use `export const dynamic = "force-dynamic"` to opt out of caching when fetching data that changes per request
  - Server components can query Prisma directly — no need for an HTTP round-trip to the API route
---

## 2026-02-11 - US-005
- Created `src/lib/elo.ts` — pure `calculateElo(winnerRating, loserRating)` function returning `{ newWinnerRating, newLoserRating }`
- Installed `vitest` as devDependency; added `"test": "vitest run"` to package.json scripts
- Created `src/lib/elo.test.ts` with 3 tests: equal ratings (±16), underdog wins (±24), favorite wins (±8)
- All 3 tests pass; typecheck and lint pass
- Files changed: `src/lib/elo.ts`, `src/lib/elo.test.ts`, `package.json`, `package-lock.json`
- **Learnings for future iterations:**
  - Vitest works out of the box for pure TypeScript utility files — no config file needed
  - ELO formula: `expectedWinner = 1 / (1 + 10^((loserRating - winnerRating) / 400))`, delta = `K * (1 - expected)`, K=32
  - When equal (1000 vs 1000): delta = 16. Underdog wins (1000 beats 1200): delta = 24. Favorite wins (1200 beats 1000): delta = 8.
  - loserDelta = -(1 - expectedWinner) which simplifies correctly since expectedLoser = 1 - expectedWinner
---

## 2026-02-11 - US-003
- Created GET /api/leaderboard endpoint at `src/app/api/leaderboard/route.ts`
- Returns players sorted by eloRating desc with rank (ties share rank), winRate (computed, whole-number %)
- Files changed: `src/app/api/leaderboard/route.ts`, `prd.json`
- **Learnings for future iterations:**
  - Rank ties: track `rank` as a separate variable that only advances when eloRating changes from previous player
  - winRate = 0 when wins + losses = 0 (avoid division by zero); use `Math.round()` for whole-number percentage
  - Next.js App Router API routes live at `src/app/api/[path]/route.ts`; no layout.tsx required for API-only routes to typecheck
---

## 2026-02-11 - US-006
- Created POST /api/matches endpoint at `src/app/api/matches/route.ts`
- Accepts `{ type: "SINGLES", winnerId: number, loserId: number }`
- Validates both player IDs exist and are distinct; returns 400 with descriptive message otherwise
- Uses Prisma transaction: creates Match + MatchPlayer records for winner/loser, updates eloRating/wins/losses atomically
- Returns 201 with matchId, type, winner/loser objects each containing id, name, oldRating, newRating, delta
- Files changed: `src/app/api/matches/route.ts`, `prd.json`
- **Learnings for future iterations:**
  - `prisma.$transaction(async (tx) => { ... })` for interactive transactions; nested create with `include` works inside transactions
  - Fetch both players with `findMany({ where: { id: { in: [id1, id2] } } })` to validate existence in a single query
  - MatchPlayer `role` field: "winner" / "loser" for singles; this extends naturally to doubles roles
---

## 2026-02-11 - US-007
- Extended POST /api/matches to handle `{ type: "DOUBLES", winnerTeam: [id, id], loserTeam: [id, id] }`
- Validates arrays of exactly 2 IDs each, all 4 IDs must be distinct numbers, all must exist in DB
- Team effective rating = average of two players' ratings; ELO delta computed from team averages
- Same delta applied uniformly: winners +delta, losers -delta (all 4 in one Prisma transaction)
- Creates Match + 4 MatchPlayer records (2 "winner", 2 "loser") atomically
- Returns 201 with matchId, type, winnerTeam/loserTeam arrays each with id, name, oldRating, newRating, delta
- Files changed: `src/app/api/matches/route.ts`, `prd.json`
- **Learnings for future iterations:**
  - Avoid destructuring unused variables from calculateElo — ESLint no-unused-vars warns on them; only destructure what you use
  - `for...of` loop over player IDs for batch player updates inside a transaction is clean and avoids Promise.all complexity
  - Doubles delta = `newWinnerAvg - winnerAvg` (positive); losers get `-delta`; individual player new ratings = `oldRating + delta`
---

## 2026-02-11 - US-008
- Removed stale root `app/` directory (create-next-app boilerplate) that was shadowing `src/app/` — this was the root cause of all routes returning 404 silently
- Created `src/app/log-match/LogMatchForm.tsx` — client component with player dropdowns (sorted A-Z, disabled when already selected in other slot), winner buttons visible only when both players selected, ELO delta confirmation, form reset on success
- Created `src/app/log-match/page.tsx` — server component fetching players from Prisma, rendering LogMatchForm
- All routes (/, /api/leaderboard, /api/matches, /log-match) now correctly appear in `npm run build` output as dynamic routes (ƒ)
- Files changed: deleted `app/*` (boilerplate), created `src/app/log-match/LogMatchForm.tsx`, `src/app/log-match/page.tsx`
- **Learnings for future iterations:**
  - Root `app/` vs `src/app/` conflict: Next.js silently picks root `app/` over `src/app/`. The server logs show compile+render times for unrecognized routes but still 404 — no error is logged. Fix: ensure no root `app/` directory exists.
  - Interactive pages: split into page.tsx (server, fetches data) + XxxForm.tsx (client, handles interaction). Pass minimal data with Prisma `select:`.
  - `disabled` on `<option>` prevents a player from being selected in the other dropdown without complex JS filtering
---

## 2026-02-11 - US-009
- Extended `src/app/log-match/LogMatchForm.tsx` with a Singles/Doubles toggle
- Doubles mode shows Team 1 (two player selects) and Team 2 (two player selects)
- Each select disables all IDs already chosen in any other slot — prevents any player appearing twice
- Winner buttons show team name + player names; success confirmation shows per-player ELO delta
- Form resets after successful submission; toggle resets form state on switch
- Extracted reusable `PlayerSelect` sub-component to avoid repeated select markup
- All quality checks pass (typecheck, lint, vitest, build)
- Files changed: `src/app/log-match/LogMatchForm.tsx`, `prd.json`
- **Learnings for future iterations:**
  - For 4-slot deduplication, pass `disabledIds` as array to each select and check with `.includes(String(id))` — simpler than global filtering
  - TypeScript discriminated union (`type: "SINGLES" | "DOUBLES"`) enables narrowing result type in JSX without casts
  - `new Set(ids.filter(Boolean)).size === ids.length` is a clean distinctness check for arrays where some may be empty strings
---

## 2026-02-11 - US-010
- Added `ADMIN_SECRET` env var to `.env` with a 32-char placeholder value
- Created `.env.example` documenting both `DATABASE_URL` and `ADMIN_SECRET` with placeholders
- Created `src/lib/adminSecret.ts` with `getAdminSecret()` and `validateAdminSecret(secret)` helpers
- `validateAdminSecret` returns a 404 NextResponse when secret is unset or doesn't match (returns null when valid)
- Files changed: `.env` (not committed — gitignored), `.env.example`, `src/lib/adminSecret.ts`
- **Learnings for future iterations:**
  - `.env` is gitignored; only `.env.example` gets committed — that's the right pattern for secrets
  - Admin routes return 404 (not 403) so attackers can't distinguish wrong-secret from not-found
  - `validateAdminSecret` returns response-or-null: `const err = validateAdminSecret(secret); if (err) return err;`
---

## 2026-02-11 - US-011
- Created `src/app/api/admin/[secret]/players/route.ts` with GET and POST handlers
- GET returns all players sorted alphabetically by name (id, name, eloRating, wins, losses)
- POST creates a player: trims whitespace, returns 400 for empty/missing name, 409 on case-insensitive duplicate, 201 on success
- Both routes return 404 for wrong/missing ADMIN_SECRET via `validateAdminSecret`
- Files changed: `src/app/api/admin/[secret]/players/route.ts`, `prd.json`
- **Learnings for future iterations:**
  - Prisma with SQLite provider does NOT support `mode: "insensitive"` in string filters — use application-level lowercase comparison instead: `players.find(p => p.name.toLowerCase() === trimmedName.toLowerCase())`
  - Dynamic route params in Next.js App Router are `Promise<{ param: string }>` — must `await params` before destructuring
---

## 2026-02-11 - US-012
- Created `src/app/admin/[secret]/page.tsx` — server component that validates secret via `getAdminSecret()` and calls `notFound()` for wrong/unset secret; fetches players alphabetically and passes to client form
- Created `src/app/admin/[secret]/AdminRosterForm.tsx` — client component with add-player form (inline error/success messages, no page reload) and player list; new players sorted into the list client-side
- Wrong secret path triggers Next.js `notFound()` which renders the app's 404 page
- Files changed: `src/app/admin/[secret]/page.tsx`, `src/app/admin/[secret]/AdminRosterForm.tsx`, `prd.json`
- **Learnings for future iterations:**
  - For page-level auth with `notFound()`: import from `next/navigation`, call it directly in the server component — no need for middleware
  - After adding a player via API, sort the new list client-side with `localeCompare` to keep alphabetical order without a round-trip
  - Disable the "Add Player" button when `name.trim().length === 0` for fast feedback; clear error/success on input change
---
