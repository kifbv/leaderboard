# Implementation Plan

<!-- Generated by Ralph planning mode. This file is updated each iteration. -->
<!-- Run `./ralph/ralph.sh plan` to generate or regenerate this plan. -->

## Project Overview

Ping Pong Leaderboard — a mobile-first web app for recording office ping pong matches and tracking ELO rankings. Stack: Next.js (App Router) + Prisma + SQLite.

## Current State

- Greenfield: `src/` directory exists but is empty — no source code yet
- Specs complete for all 3 features: See the Standings, Record a Match, Manage the Roster
- Implementation plan and prd.json created; no stories started

## Tasks

Tasks are ordered by dependency: setup → schema → backend logic → API routes → UI.

### Phase 1: Project Setup & Schema

- **US-001: Initialize Next.js project with Prisma and SQLite** ✅ DONE
  - Next.js 16, TypeScript, Tailwind CSS, App Router
  - Prisma 7 with SQLite via `@prisma/adapter-better-sqlite3` driver adapter
  - Player, Match, MatchPlayer models with initial migration
  - Note: Prisma 7 requires driver adapter; `@/*` alias maps to root not src/

### Phase 2: Seed Data & Leaderboard Backend

- **US-002: Create database seed script** ✅ DONE
  - Seed at least 5 players with varying ELO, wins, losses
  - Script must be idempotent
  - Note: Prisma 7 seed config lives in `prisma.config.ts` (migrations.seed), not package.json; use `tsx` runner
  - Source: see-the-standings.md US-004

- **US-003: Create leaderboard API endpoint** ✅ DONE
  - GET /api/leaderboard returns all players sorted by eloRating desc
  - Include rank (1-indexed, ties share rank), id, name, eloRating, wins, losses, winRate (computed)
  - Players with zero matches included (winRate = 0)
  - Source: see-the-standings.md US-002

### Phase 3: Leaderboard UI

- **US-004: Build leaderboard page** ✅ DONE
  - Landing page (/) with server component showing ranked player list
  - Columns: rank, name, ELO, wins, losses, win rate %
  - Include basic app layout shell with navigation (link to "Log Match" page)
  - Mobile-first (375px), empty state when no players
  - Note: ESLint immutability rule — use reduce not let+map for rank computation
  - Source: see-the-standings.md US-003

### Phase 4: ELO Calculation & Match Backend

- **US-005: Create ELO calculation utility** ✅ DONE
  - Pure function in lib/elo.ts: `calculateElo(winnerRating, loserRating)` → `{ newWinnerRating, newLoserRating }`
  - Standard ELO formula, K=32. Vitest installed; 3 tests pass.
  - Source: record-a-match.md US-001

- **US-006: Create singles match recording API** ✅ DONE
  - POST /api/matches with { type: "SINGLES", winnerId, loserId }
  - Validate player IDs exist and differ
  - Atomic transaction: create Match, update ELO/wins/losses
  - Return match with old/new ratings
  - Source: record-a-match.md US-002

- **US-007: Create doubles match recording API** ✅ DONE
  - POST /api/matches with { type: "DOUBLES", winnerTeam: [id, id], loserTeam: [id, id] }
  - Validate 4 distinct player IDs
  - Team ELO = average of players; same delta for all 4 players
  - Atomic transaction
  - Source: record-a-match.md US-003

### Phase 5: Match Logging UI

- **US-008: Build singles match logging UI** ✅ DONE
  - "Log Match" page accessible from navigation
  - Singles selected by default, two player dropdowns (no duplicate selection, sorted alphabetically)
  - Submit disabled until both players selected
  - Winner buttons, success confirmation with ELO delta
  - Form resets after submission, mobile-first
  - Bug fixed: root `app/` boilerplate was shadowing `src/app/`, causing all routes to 404 silently
  - Source: record-a-match.md US-004

- **US-009: Build doubles match logging UI** ✅ DONE
  - Extends LogMatchForm.tsx with Singles/Doubles toggle
  - Team 1 / Team 2 each get two player selects; cross-slot deduplication via disabledIds array
  - Winner team buttons show team name + player names; confirmation shows per-player ELO delta
  - Form resets after submission; toggle switch also resets form state
  - Extracted reusable PlayerSelect sub-component
  - Source: record-a-match.md US-005

### Phase 6: Admin / Roster Management

- **US-010: Set up admin secret and environment config**
  - ADMIN_SECRET env var (minimum 16 chars)
  - .env.example with placeholder
  - Admin routes return 404 when secret not set or wrong
  - Source: manage-the-roster.md US-001

- **US-011: Create admin player API endpoints**
  - POST /api/admin/[secret]/players — create player (name validation, 409 on duplicate, case-insensitive)
  - GET /api/admin/[secret]/players — list all players alphabetically
  - Both return 404 for wrong secret
  - Player names trimmed of whitespace before saving
  - Source: manage-the-roster.md US-002 + US-003

- **US-012: Build admin roster management UI**
  - Page at /admin/[secret] showing player list + add player form
  - Inline error messages, no full page reload on add
  - 404 for wrong secret, mobile-first
  - Source: manage-the-roster.md US-004

## Notes

- All stories must pass `npx tsc --noEmit`
- All UI stories must be verified in browser at 375px viewport
- Match model uses MatchPlayer join table to support both singles (2 players) and doubles (4 players)
- ELO is stored as integer, win rate is computed at query time
- Player dropdowns sorted alphabetically per spec
