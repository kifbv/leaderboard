# Implementation Plan

<!-- Generated by Ralph planning mode. This file is updated each iteration. -->
<!-- Run `./ralph/ralph.sh plan` to generate or regenerate this plan. -->

## Project Overview

Ping Pong Leaderboard — a mobile-first web app for recording office ping pong matches and tracking ELO rankings. Stack: Next.js (App Router) + Prisma + SQLite.

## Current State

- All functionality complete (US-001 through US-012)
- UI uses basic light-mode styling — needs restyling to match design references in `designs/`
- Phase 7 (Design Alignment) adds US-013 through US-021 for visual polish

## Tasks

Tasks are ordered by dependency: setup → schema → backend logic → API routes → UI.

### Phase 1: Project Setup & Schema

- **US-001: Initialize Next.js project with Prisma and SQLite** ✅ DONE
  - Next.js 16, TypeScript, Tailwind CSS, App Router
  - Prisma 7 with SQLite via `@prisma/adapter-better-sqlite3` driver adapter
  - Player, Match, MatchPlayer models with initial migration
  - Note: Prisma 7 requires driver adapter; `@/*` alias maps to root not src/

### Phase 2: Seed Data & Leaderboard Backend

- **US-002: Create database seed script** ✅ DONE
  - Seed at least 5 players with varying ELO, wins, losses
  - Script must be idempotent
  - Note: Prisma 7 seed config lives in `prisma.config.ts` (migrations.seed), not package.json; use `tsx` runner
  - Source: see-the-standings.md US-004

- **US-003: Create leaderboard API endpoint** ✅ DONE
  - GET /api/leaderboard returns all players sorted by eloRating desc
  - Include rank (1-indexed, ties share rank), id, name, eloRating, wins, losses, winRate (computed)
  - Players with zero matches included (winRate = 0)
  - Source: see-the-standings.md US-002

### Phase 3: Leaderboard UI

- **US-004: Build leaderboard page** ✅ DONE
  - Landing page (/) with server component showing ranked player list
  - Columns: rank, name, ELO, wins, losses, win rate %
  - Include basic app layout shell with navigation (link to "Log Match" page)
  - Mobile-first (375px), empty state when no players
  - Note: ESLint immutability rule — use reduce not let+map for rank computation
  - Source: see-the-standings.md US-003

### Phase 4: ELO Calculation & Match Backend

- **US-005: Create ELO calculation utility** ✅ DONE
  - Pure function in lib/elo.ts: `calculateElo(winnerRating, loserRating)` → `{ newWinnerRating, newLoserRating }`
  - Standard ELO formula, K=32. Vitest installed; 3 tests pass.
  - Source: record-a-match.md US-001

- **US-006: Create singles match recording API** ✅ DONE
  - POST /api/matches with { type: "SINGLES", winnerId, loserId }
  - Validate player IDs exist and differ
  - Atomic transaction: create Match, update ELO/wins/losses
  - Return match with old/new ratings
  - Source: record-a-match.md US-002

- **US-007: Create doubles match recording API** ✅ DONE
  - POST /api/matches with { type: "DOUBLES", winnerTeam: [id, id], loserTeam: [id, id] }
  - Validate 4 distinct player IDs
  - Team ELO = average of players; same delta for all 4 players
  - Atomic transaction
  - Source: record-a-match.md US-003

### Phase 5: Match Logging UI

- **US-008: Build singles match logging UI** ✅ DONE
  - "Log Match" page accessible from navigation
  - Singles selected by default, two player dropdowns (no duplicate selection, sorted alphabetically)
  - Submit disabled until both players selected
  - Winner buttons, success confirmation with ELO delta
  - Form resets after submission, mobile-first
  - Bug fixed: root `app/` boilerplate was shadowing `src/app/`, causing all routes to 404 silently
  - Source: record-a-match.md US-004

- **US-009: Build doubles match logging UI** ✅ DONE
  - Extends LogMatchForm.tsx with Singles/Doubles toggle
  - Team 1 / Team 2 each get two player selects; cross-slot deduplication via disabledIds array
  - Winner team buttons show team name + player names; confirmation shows per-player ELO delta
  - Form resets after submission; toggle switch also resets form state
  - Extracted reusable PlayerSelect sub-component
  - Source: record-a-match.md US-005

### Phase 6: Admin / Roster Management

- **US-010: Set up admin secret and environment config** ✅ DONE
  - `ADMIN_SECRET` added to `.env` (32-char value); `.env.example` created with placeholder
  - `src/lib/adminSecret.ts`: `validateAdminSecret(secret)` returns 404 response when unset/wrong, null when valid
  - Source: manage-the-roster.md US-001

- **US-011: Create admin player API endpoints** ✅ DONE
  - POST /api/admin/[secret]/players — create player (name validation, 409 on duplicate, case-insensitive)
  - GET /api/admin/[secret]/players — list all players alphabetically
  - Both return 404 for wrong secret
  - Player names trimmed of whitespace before saving
  - Note: SQLite doesn't support Prisma `mode: "insensitive"` — use app-level lowercase comparison
  - Source: manage-the-roster.md US-002 + US-003

- **US-012: Build admin roster management UI** ✅ DONE
  - Page at /admin/[secret] showing player list + add player form
  - Inline error messages, no full page reload on add
  - Wrong secret calls `notFound()` → renders app 404 page
  - New players sorted into list client-side with `localeCompare`
  - Source: manage-the-roster.md US-004

### Phase 7: Design Alignment (UI Restyle)

All functionality is complete. This phase restyles the UI to match the design references in `designs/`.

- [ ] **US-013: Set up global dark theme with Lexend font and color tokens**
  - Import Lexend + Material Symbols fonts in globals.css
  - Define Tailwind theme tokens: primary (#135bec), bg-dark (#0b121e), card-dark (#0d1625)
  - Update layout.tsx: dark mode, Lexend font, remove old light nav bar
  - Source: designs/global-leaderboard.html

- [ ] **US-014: Restyle leaderboard — sticky header and floating action button**
  - Sticky header with blur backdrop, sports_tennis icon, "TGSB Leaderboard" title
  - Floating "Log Match" FAB button (bottom-right, primary color, rounded-full with shadow)
  - No search bar (out of v1 scope), no bottom nav (out of v1 scope)
  - Source: designs/global-leaderboard.html

- [ ] **US-015: Restyle leaderboard — top-3 podium layout**
  - 1st place centered/larger with primary border and glow, "1st" badge
  - 2nd place left with slate border, "2nd" badge
  - 3rd place right with bronze border, "3rd" badge
  - Initials circles (not avatar images — out of v1 scope)
  - Each: name, ELO in primary, W-L subtitle
  - Handle <3 players gracefully
  - Source: designs/global-leaderboard.html

- [ ] **US-016: Restyle leaderboard — card rows for 4th+ players**
  - Replace HTML table with card-style rows per design
  - Each card: rank number, initials avatar circle, name, "XW - YL · Z% Win", ELO right-aligned in primary
  - Dark card background (#0d1625), rounded-2xl, hover state
  - Update empty state for dark mode
  - Source: designs/global-leaderboard.html

- [ ] **US-017: Restyle log match page — modal layout, header, and dark theme**
  - Modal-style full screen with close (X) button linking to /
  - Centered "Log Match" title in header
  - Dark mode background, Lexend font
  - Restyle Singles/Doubles toggle for dark mode
  - Source: designs/log-match-result.html

- [ ] **US-018: Restyle log match page — dropdowns and "Who played?" section**
  - "Who played?" heading with subtitle, centered
  - 2-column grid player dropdowns with primary color uppercase labels
  - Dark-styled selects: dark bg, slate borders, rounded-xl, custom chevron
  - Source: designs/log-match-result.html

- [ ] **US-019: Restyle log match page — winner buttons and feedback**
  - Restyle winner selection buttons for dark mode (primary color, rounded, shadow)
  - Restyle success/error feedback for dark mode
  - Source: designs/log-match-result.html

- [ ] **US-020: Restyle admin page for dark mode consistency**
  - No design reference — inherit global dark theme
  - Dark inputs, primary buttons, card-dark player list, white text
  - Source: none (consistency pass)

- [ ] **US-021: Final QA — build, lint, typecheck, visual verification**
  - `npx tsc --noEmit` passes
  - `npm run build` passes
  - `npm run lint` passes
  - Visual check at 375px for all three pages

## Notes

- All stories must pass `npx tsc --noEmit`
- All UI stories must be verified in browser at 375px viewport
- Match model uses MatchPlayer join table to support both singles (2 players) and doubles (4 players)
- ELO is stored as integer, win rate is computed at query time
- Player dropdowns sorted alphabetically per spec
