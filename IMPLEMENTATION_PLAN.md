# Implementation Plan

<!-- Generated by Ralph planning mode. This file is updated each iteration. -->
<!-- Run `./ralph/ralph.sh plan` to generate or regenerate this plan. -->

## Project Overview

Ping Pong Leaderboard — a mobile-first web app for recording office ping pong matches and tracking ELO rankings. Stack: Next.js (App Router) + Prisma + SQLite.

## Current State

- All functionality complete (US-001 through US-012)
- UI uses basic light-mode styling — needs restyling to match design references in `designs/`
- Phase 7 (Design Alignment) adds US-013 through US-021 for visual polish

## Tasks

Tasks are ordered by dependency: setup → schema → backend logic → API routes → UI.

### Phase 1: Project Setup & Schema

- **US-001: Initialize Next.js project with Prisma and SQLite** ✅ DONE
  - Next.js 16, TypeScript, Tailwind CSS, App Router
  - Prisma 7 with SQLite via `@prisma/adapter-better-sqlite3` driver adapter
  - Player, Match, MatchPlayer models with initial migration
  - Note: Prisma 7 requires driver adapter; `@/*` alias maps to root not src/

### Phase 2: Seed Data & Leaderboard Backend

- **US-002: Create database seed script** ✅ DONE
  - Seed at least 5 players with varying ELO, wins, losses
  - Script must be idempotent
  - Note: Prisma 7 seed config lives in `prisma.config.ts` (migrations.seed), not package.json; use `tsx` runner
  - Source: see-the-standings.md US-004

- **US-003: Create leaderboard API endpoint** ✅ DONE
  - GET /api/leaderboard returns all players sorted by eloRating desc
  - Include rank (1-indexed, ties share rank), id, name, eloRating, wins, losses, winRate (computed)
  - Players with zero matches included (winRate = 0)
  - Source: see-the-standings.md US-002

### Phase 3: Leaderboard UI

- **US-004: Build leaderboard page** ✅ DONE
  - Landing page (/) with server component showing ranked player list
  - Columns: rank, name, ELO, wins, losses, win rate %
  - Include basic app layout shell with navigation (link to "Log Match" page)
  - Mobile-first (375px), empty state when no players
  - Note: ESLint immutability rule — use reduce not let+map for rank computation
  - Source: see-the-standings.md US-003

### Phase 4: ELO Calculation & Match Backend

- **US-005: Create ELO calculation utility** ✅ DONE
  - Pure function in lib/elo.ts: `calculateElo(winnerRating, loserRating)` → `{ newWinnerRating, newLoserRating }`
  - Standard ELO formula, K=32. Vitest installed; 3 tests pass.
  - Source: record-a-match.md US-001

- **US-006: Create singles match recording API** ✅ DONE
  - POST /api/matches with { type: "SINGLES", winnerId, loserId }
  - Validate player IDs exist and differ
  - Atomic transaction: create Match, update ELO/wins/losses
  - Return match with old/new ratings
  - Source: record-a-match.md US-002

- **US-007: Create doubles match recording API** ✅ DONE
  - POST /api/matches with { type: "DOUBLES", winnerTeam: [id, id], loserTeam: [id, id] }
  - Validate 4 distinct player IDs
  - Team ELO = average of players; same delta for all 4 players
  - Atomic transaction
  - Source: record-a-match.md US-003

### Phase 5: Match Logging UI

- **US-008: Build singles match logging UI** ✅ DONE
  - "Log Match" page accessible from navigation
  - Singles selected by default, two player dropdowns (no duplicate selection, sorted alphabetically)
  - Submit disabled until both players selected
  - Winner buttons, success confirmation with ELO delta
  - Form resets after submission, mobile-first
  - Bug fixed: root `app/` boilerplate was shadowing `src/app/`, causing all routes to 404 silently
  - Source: record-a-match.md US-004

- **US-009: Build doubles match logging UI** ✅ DONE
  - Extends LogMatchForm.tsx with Singles/Doubles toggle
  - Team 1 / Team 2 each get two player selects; cross-slot deduplication via disabledIds array
  - Winner team buttons show team name + player names; confirmation shows per-player ELO delta
  - Form resets after submission; toggle switch also resets form state
  - Extracted reusable PlayerSelect sub-component
  - Source: record-a-match.md US-005

### Phase 6: Admin / Roster Management

- **US-010: Set up admin secret and environment config** ✅ DONE
  - `ADMIN_SECRET` added to `.env` (32-char value); `.env.example` created with placeholder
  - `src/lib/adminSecret.ts`: `validateAdminSecret(secret)` returns 404 response when unset/wrong, null when valid
  - Source: manage-the-roster.md US-001

- **US-011: Create admin player API endpoints** ✅ DONE
  - POST /api/admin/[secret]/players — create player (name validation, 409 on duplicate, case-insensitive)
  - GET /api/admin/[secret]/players — list all players alphabetically
  - Both return 404 for wrong secret
  - Player names trimmed of whitespace before saving
  - Note: SQLite doesn't support Prisma `mode: "insensitive"` — use app-level lowercase comparison
  - Source: manage-the-roster.md US-002 + US-003

- **US-012: Build admin roster management UI** ✅ DONE
  - Page at /admin/[secret] showing player list + add player form
  - Inline error messages, no full page reload on add
  - Wrong secret calls `notFound()` → renders app 404 page
  - New players sorted into list client-side with `localeCompare`
  - Source: manage-the-roster.md US-004

### Phase 7: Design Alignment (UI Restyle)

All functionality is complete. This phase restyles the UI to match the design references in `designs/`.

**Current state:** All pages use light-mode styling (bg-gray-50, white cards, gray borders, blue-600 accents). Layout has a light nav bar in layout.tsx. Leaderboard uses an HTML `<table>`. Log Match uses stacked dropdowns with gray labels. No custom fonts.

**Target state:** Dark mode throughout, Lexend + Material Symbols fonts, primary blue #135bec, podium top-3, card rows, modal-style log match.

**Tailwind v4 note:** This project uses Tailwind v4 (`@import "tailwindcss"` in globals.css, `@tailwindcss/postcss` in postcss.config.mjs). There is no `tailwind.config.js`. Custom theme tokens must be defined using `@theme {}` block in `globals.css`.

- [x] **US-013: Set up global dark theme with Lexend font and color tokens**
  - **globals.css:** Add `@theme {}` block with custom colors: `--color-primary: #135bec`, `--color-background-dark: #0b121e`, `--color-card-dark: #0d1625`, `--color-background-light: #f6f6f8`
  - **globals.css:** Import Google Fonts (Lexend 100..900, Material Symbols Outlined) via `@import url(...)` at top of file
  - **globals.css:** Set `body { font-family: 'Lexend', sans-serif; }` base style
  - **layout.tsx:** Add `className="dark"` to `<html>` tag, set `<body>` to `bg-background-dark text-white min-h-screen`
  - **layout.tsx:** Remove the existing `<nav>` bar entirely (pages will handle their own headers)
  - **layout.tsx:** Wrap `{children}` in `<div className="max-w-md mx-auto">` for mobile-first centering
  - Files: `src/app/globals.css`, `src/app/layout.tsx`
  - Source: designs/global-leaderboard.html, designs/log-match-result.html

- [x] **US-014: Restyle leaderboard — sticky header and floating action button**
  - **Header:** Replace `<h1>Standings</h1>` with sticky header: `sticky top-0 z-30 bg-background-dark/80 backdrop-blur-lg px-6 pt-10 pb-4`
  - **Header content:** Flex row with Material Symbol `sports_tennis` icon (text-primary text-4xl) + "TGSB Leaderboard" h1 (text-2xl font-bold)
  - **FAB:** Add fixed-position "Log Match" button: `fixed bottom-8 right-6 px-8 py-4 bg-primary text-white rounded-full shadow-[0_8px_30px_rgb(19,91,236,0.4)]` linking to `/log-match`
  - **No search bar** (out of v1 scope), **no bottom nav** (out of v1 scope)
  - Files: `src/app/page.tsx`
  - Source: designs/global-leaderboard.html

- [x] **US-015: Restyle leaderboard — top-3 podium layout**
  - **Layout:** Flex row with `items-end justify-center gap-4`, order: 2nd (left) → 1st (center, raised with -mt-4) → 3rd (right)
  - **1st place:** w-20 h-20 circle, border-4 border-primary, box-shadow glow `shadow-[0_0_20px_rgba(19,91,236,0.3)]`, "1st" badge in primary bg
  - **2nd place:** w-16 h-16 circle, border-2 border-slate-700, "2nd" badge in slate-600 bg
  - **3rd place:** w-16 h-16 circle, border-2 border-[#b87333]/50, "3rd" badge in [#b87333]/80 bg
  - **Avatar circles:** Show player initials (first letter of name) with deterministic bg color (hash name to pick from palette), not images
  - **Stats below each:** Name (truncated, text-xs for 2nd/3rd, text-sm for 1st), ELO in primary color, "XW - YL" in text-slate-500 uppercase
  - **Edge case:** If <3 players, only show the available positions; if 0–1 players, skip podium entirely
  - Files: `src/app/page.tsx`
  - Source: designs/global-leaderboard.html

- [x] **US-016: Restyle leaderboard — card rows for 4th+ players**
  - **Remove** existing `<table>` markup
  - **Each card:** `flex items-center gap-4 bg-card-dark p-4 rounded-2xl` with hover: `hover:bg-slate-800/40`
  - **Card content:** Rank number (text-sm font-bold text-slate-400 w-4) → Initials avatar circle (w-12 h-12 rounded-full) → Name + subtitle in flex-1 → ELO right-aligned in primary
  - **Subtitle format:** `{wins}W - {losses}L · {winRate}% Win` in text-[10px] text-slate-500 uppercase
  - **Empty state:** Update to dark mode styling (text-slate-500)
  - Files: `src/app/page.tsx`
  - Source: designs/global-leaderboard.html

- [x] **US-017: Restyle log match page — modal layout, header, and dark theme**
  - **Container:** Full-screen modal style: `min-h-screen bg-background-dark flex flex-col`
  - **Header:** Sticky with blur, 3-column layout: close (X) button left (Material Symbol `close`, links to `/`) → "Log Match" title center → empty spacer right
  - **Header styling:** `border-b border-slate-800`, bg-background-dark/80 backdrop-blur-md
  - **Singles/Doubles toggle:** Restyle: active tab = `bg-primary text-white`, inactive = `bg-slate-800 text-slate-400`
  - Files: `src/app/log-match/LogMatchForm.tsx`, `src/app/log-match/page.tsx`
  - Source: designs/log-match-result.html

- [x] **US-018: Restyle log match page — dropdowns and "Who played?" section**
  - **Heading section:** Centered "Who played?" (text-2xl font-bold) + "Select the match participants." subtitle (text-slate-500 text-sm)
  - **Grid layout:** `grid grid-cols-2 gap-4` for Player 1 / Player 2 in singles mode
  - **Labels:** `text-[10px] font-bold uppercase tracking-widest text-primary` (e.g. "PLAYER 1", "PLAYER 2")
  - **Select elements:** `bg-slate-900 border border-slate-800 rounded-xl py-3 px-3 text-sm text-white`, custom chevron SVG via CSS `background-image`
  - **Doubles mode:** Similar grid but 2 rows per team, with "Team 1" / "Team 2" section headers
  - Files: `src/app/log-match/LogMatchForm.tsx`
  - Source: designs/log-match-result.html

- [x] **US-019: Restyle log match page — winner buttons and feedback**
  - **Winner buttons:** `bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-2xl shadow-lg shadow-primary/20`
  - **Disabled state:** `bg-slate-800 text-slate-500 cursor-not-allowed` (replace gray-300)
  - **Success feedback:** `bg-green-900/30 border border-green-800 text-green-400` (dark-mode green)
  - **Error feedback:** `bg-red-900/30 border border-red-800 text-red-400` (dark-mode red)
  - **Loading text:** `text-slate-400`
  - Files: `src/app/log-match/LogMatchForm.tsx`
  - Source: designs/log-match-result.html

- [x] **US-020: Restyle admin page for dark mode consistency**
  - **No design reference** — inherit global dark theme for consistency
  - **Heading:** White text (inherits from body)
  - **Form input:** `bg-slate-900 border border-slate-800 text-white rounded-xl px-3 py-2 focus:ring-2 focus:ring-primary/50`
  - **Add button:** `bg-primary text-white hover:bg-primary/90 rounded-xl`
  - **Player list:** `bg-card-dark rounded-2xl divide-slate-800` with white names, slate-400 ELO text
  - **Empty state:** `text-slate-500`
  - **Error/success messages:** Same dark-mode styling as log match page
  - Files: `src/app/admin/[secret]/AdminRosterForm.tsx`
  - Source: none (consistency pass)

- [x] **US-021: Final QA — build, lint, typecheck, visual verification**
  - `npx tsc --noEmit` passes ✅
  - `npm run build` passes ✅
  - `npm run lint` passes ✅ (fixed: Link component, unused var)
  - Visual check at 375px — pending manual browser review

## Notes

- All stories must pass `npx tsc --noEmit`
- All UI stories must be verified in browser at 375px viewport
- Match model uses MatchPlayer join table to support both singles (2 players) and doubles (4 players)
- ELO is stored as integer, win rate is computed at query time
- Player dropdowns sorted alphabetically per spec
- **Tailwind v4:** Custom theme tokens use `@theme {}` in globals.css, not a JS config file
- **Fonts:** Lexend from Google Fonts, Material Symbols Outlined for icons
- **No functionality changes** — all stories in Phase 7 are styling-only
